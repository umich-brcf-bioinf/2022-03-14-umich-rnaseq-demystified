---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

*TODO: EDIT EXERCISE TO HAVE CLEAR DIRECTIONS + MAKE SOLUTION VERSION FOR HELPERS*


## [Breakout Exercise 1]: - PCA plot for raw data

It be useful to also generate a PCA plot for the raw data as well as the normalized data, particularly if there are concerns about normalizing across diverse tissues or large samples

```{r PCAPlainRaw}
RC <- SummarizedExperiment(log2(counts(dds, normalized = FALSE)), colData=colData(dds))
p.raw <- plotPCA(DESeqTransform(RC), intgroup = c('Gtype.Tx'), ntop = 500)
p.raw
```

We see that there is less variance explained by PC2 and that the samples from the same group are not as well clustered for the raw data. Since this is prior to normalization, these differences are likely due to **technical** considerations like sequencing depth differences that are accounted for by the rlog normalization.  

<details>
    <summary>*Click for code for customized PCA plot of raw data*</summary>
```{r PCAraw}
pdf(file = paste0(plotPath, 'PCAplot_raw_', Comparison, '.pdf'), onefile = TRUE)
#PCA for Raw counts for all samples
RC <- SummarizedExperiment(log2(counts(dds, normalized = FALSE)), colData=colData(dds))
p.RC <- plotPCA(DESeqTransform(RC), intgroup = 'Gtype.Tx')

gpRC <- ggplot(p.RC$data, aes(x = PC1, y = PC2, color = SampleName, shape = CombinatoricGroup)) +     xlab(p.RC$labels[2]) + ylab(p.RC$labels[1]) + scale_shape_manual(values=1:nlevels(CombinatoricGroup), name = 'Combinatoric Group') + geom_point(size=2) + ggtitle(label = as.character('All samples Raw Data')) + theme(plot.title = element_text(hjust = 0.5)) + guides(colour=guide_legend(nrow=12, title = 'Sample'), legend.key = element_rect(size = 1), legend.key.size = unit(0, 'cm')) + theme_classic(base_size = 10) + theme(legend.margin=margin(t = 0, unit='mm'))
plot(gpRC)

dev.off()

# embedd example of plot (rlog only)
plot(gpRC)
```



### BONUS: PCA plot customization with ggplot2

We can also generate a customized plot using the `ggplot2` package that will include shape assignments for our treatment groups and color assignments for the individual samples.


First, create some objects to store the sample and group information.
```{r PCAexerciseA}
#PCA plot for Rlog-Normalized counts for all samples
CombinatoricGroup <- factor(MetaInfo$Gtype.Tx)
SampleName <- factor(row.names(MetaInfo))
```
Take a look at `CombinatoricGroup` and `SampleName` - what information is now stored in these objects?
  
  Next, look at the documentation for `plotPCA` function from DESeq2. Then write a command to store the PCA results for the top 500 genes for `intgroup` = 'Gtype.Tx', using the normalized data, as an object named `p.all`.

<details>
  <summary>*Click for solution*</summary>
```{r PCAexerciseB}
#Generate the PCA projections using the `plotPCA` function from DESeq2.
p.all <- plotPCA(rld, intgroup = c('Gtype.Tx'), ntop = 500)
```
</details>
  
  Next, look at the possible slots of the `p.all` object to determine where the PCA data is stored. Then, create a ggplot2 object called `gp`, specifying PC1 as the x-axis and PC2 as the y-axis and setting the color to correspond to the samples and the shape to correspond to the `CombinatoricGroup`. Add a primary title 'All samples Rlog-Normalized'

*Hint: Use aesthetics, e.g.: aes() and search for how to add a title to a ggplot figure*
  
  <details>
  <summary>*Click for solution*</summary>
```{r PCAexerciseC}
gp <- ggplot(p.all$data, aes(x = PC1, y = PC2, color = SampleName, shape = CombinatoricGroup)) +
  geom_point() +
  ggtitle(label = as.character('All samples Rlog-Normalized'))
```
</details>
  
  
  Finally, to **output** the plot to file, use the `pdf()` function:
```{r PCAexerciseOutput}
pdf(file = paste0(plotPath, 'PCAplot_Fancy_rlog_', Comparison, '.pdf'), onefile = TRUE)
plot(gp)
dev.off()
```

